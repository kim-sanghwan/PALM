import numpy as np
import numpy.typing as npt
import torch 
from transformers import LogitsProcessor


frequent_vn = list(set([4898, 13608, 2046, 3822, 4314, 3526, 2604, 34840, 39599, 35960, 3822, 30605, 4898, 3323, 4898, 1818, 21558, 16270, 9664, 30594, 479, 16484, 34232, 9290, 3091, 6383, 261, 1339, 39731, 27021, 15762, 17379, 474, 6996, 5171, 885, 70, 2353, 5301, 16846, 19638, 6143, 6873, 19783, 6131, 16918, 36104, 7514, 1169, 710, 36594, 5360, 3202, 23704, 45391, 15936, 15936, 263, 35370, 18100, 17864, 9580, 6503, 21302, 7862, 31894, 21716, 15050, 17214, 4618, 3600, 1216, 623, 302, 276, 9403, 1359, 10157, 549, 10717, 17793, 20349, 4731, 29202, 8800, 29654, 35938, 29092, 599, 970, 37923, 4704, 665, 500, 25749, 21181, 7521, 32680, 12581, 474, 11025, 15857, 1790, 4057, 2655, 9580, 26230, 2657, 26819, 3348, 3526, 19789, 1451, 3002, 9294, 42903, 277, 14272, 316, 9814, 40206, 27268, 527, 8262, 5977, 7533, 3465, 3348, 3323, 11968, 14507, 6450, 6147, 15299, 19550, 13915, 18619, 4038, 1085, 7771, 7825, 48216, 20534, 10017, 29871, 24556, 24556, 913, 3425, 32959, 6839, 10746, 6839, 9260, 13647, 17492, 9154, 3953, 15558, 25422, 5116, 1021, 6122, 17351, 1113, 1155, 660, 10712, 19916, 21219, 14147, 45808, 9845, 285, 4891, 660, 18757, 5584, 32256, 1976, 1229, 45045, 6508, 25152, 256, 2178, 1754, 34561, 11506, 1008, 1492, 42702, 7093, 10107, 20922, 5337, 2443, 28979, 14093, 9396, 3355, 19828, 12835, 2666, 1234, 1295, 2666, 4268, 1011, 2298, 5552, 651, 1445, 4351, 1208, 5163, 4532, 16697, 2620, 4646, 1487, 2005, 15797, 16416, 30506, 1745, 1104, 11762, 13180, 4781, 2834, 3424, 16085, 27268, 285, 404, 8977, 10303, 13502, 7906, 23064, 14283, 625, 1280, 3638, 19550, 4836, 7521, 12797, 3714, 12153, 10285, 34291, 1969, 4174, 4104, 35180, 10199, 6107, 12, 259, 4654, 3049, 268, 2018, 8076, 779, 5980, 3904, 12, 16539, 3283, 15936, 4574, 5591, 1803, 2277, 10643, 15554, 19916, 21674, 3892, 268, 3297, 14983, 10548, 2353, 9185, 5022, 21229, 3953, 10164, 1317, 42778, 23529, 2270, 10104, 2198, 804, 10716, 1570, 13279, 3002, 572, 9580, 48224, 555, 16875, 14274, 566, 22837, 31833, 1210, 5078, 319, 923, 1657, 11662]))
vtokens = [4532, 16697, 2620, 4646, 1487, 4174, 4104, 35180, 21674, 3892, 268, 3297, 14983, 10548, 10199, 6107, 12, 259, 4654, 3049, 268, 2018, 6611, 2270, 3283, 4929, 537, 499, 3424, 16085, 27268, 285, 404, 8977, 12080, 1969, 15000, 6938, 31145, 4483, 4144, 954, 3002, 46149, 2005, 15797, 16416, 30506, 48224, 555, 16875, 14274, 566, 22837, 3100, 19550, 14083, 6626, 4553, 3197, 16007, 3708, 6594, 3802, 3745, 2393, 351, 2891, 6070, 5591, 32959, 1577, 48612, 20078, 8181, 2277, 10643, 15554, 1745, 1104, 11762, 13180, 7550, 10104, 2198, 804, 10716, 1570, 6953, 4829, 638, 1329, 30495, 10303, 5793, 40953, 1317, 3953, 10164, 5022, 15936, 1445, 4351, 1208, 5163, 1280, 8076, 779, 5980, 3904, 12, 16539, 2353, 7521, 3952, 31738, 4273, 4618, 711, 966, 12797, 1803, 2834, 8901, 4574, 1234, 1295, 2666, 4268, 1100, 4781, 9185, 4836, 6450, 23529, 42778, 9580, 10743, 2989, 4691, 34249, 37982, 24695, 13279, 13986, 3617, 36273, 264, 12311, 1650, 7209, 11662, 45799, 21229, 1302, 2239, 4859, 9154, 22749, 7539, 9628, 1011, 2298, 5552, 651, 1561, 9427, 369, 4399, 3714, 12153, 10285, 34291, 9839, 31833, 26500, 3638, 1210, 7906, 23064, 14283, 625, 572, 5078, 319, 923, 1657, 23658, 16631, 555, 2487, 28594, 1809, 1418, 494, 2513, 13502, 1660, 5806, 26650, 19916, 3551, 19974]
ntokens = [17180, 257, 31186, 3211, 16257, 1242, 3197, 8263, 12036, 17548, 355, 1845, 31111, 40377, 3253, 75, 23272, 5156, 21385, 6131, 16918, 36104, 7514, 1169, 710, 36594, 5360, 3202, 23704, 45391, 16871, 20584, 2613, 9283, 9669, 14121, 21190, 25996, 4618, 391, 2318, 2779, 3526, 7988, 7365, 5701, 2891, 7837, 37995, 4984, 11710, 6555, 49773, 307, 3110, 26394, 3996, 10999, 7624, 275, 6996, 24968, 4144, 13135, 6099, 37392, 17026, 7161, 18447, 3996, 21760, 7043, 16809, 40047, 2512, 2587, 698, 789, 18100, 7925, 273, 1492, 42702, 7093, 10107, 20922, 5337, 2443, 28979, 1492, 7442, 9294, 42903, 9396, 42893, 275, 9248, 20439, 2270, 14841, 8478, 8509, 28773, 28022, 7246, 6228, 29573, 40134, 5724, 72, 7619, 5049, 17214, 44653, 47085, 47085, 13915, 14093, 14310, 27142, 19236, 44983, 26593, 9215, 35113, 4936, 41266, 13447, 26247, 6508, 3526, 28260, 2386, 9346, 4676, 460, 21996, 26839, 21978, 1097, 4038, 2657, 26819, 3348, 3526, 20710, 40562, 6383, 256, 42639, 3797, 13387, 18725, 1924, 2685, 78, 20534, 10017, 29871, 33158, 442, 2001, 6333, 5118, 30860, 9891, 9015, 11594, 2057, 4898, 6, 6147, 4898, 442, 36811, 11311, 45274, 3096, 30506, 13915, 17779, 44931, 10349, 29405, 21558, 10651, 8801, 16270, 9664, 30594, 479, 16484, 34232, 42450, 20132, 6891, 4572, 951, 4066, 1974, 3644, 20966, 324, 13224, 32768, 3159, 9290, 3091, 6383, 261, 1339, 39731, 27021, 15762, 17379, 474, 6996, 5171, 885, 70, 2353, 5301, 16846, 19638, 6143, 6873, 19783, 37171, 19751, 269, 967, 11676, 5228, 3753, 4852, 3753, 32202, 8469, 263, 36228, 5013, 1067, 323, 261, 8566, 46149, 37593, 5657, 38421, 4494, 6508, 25152, 256, 2178, 1754, 29461, 33579, 38121, 42050, 45618, 33749, 293, 333, 2206, 6783, 17963, 4656, 9433, 45146, 3290, 3420, 3420, 7923, 15756, 33938, 15756, 14930, 33451, 6576, 16007, 1553, 4665, 1643, 13026, 13526, 7923, 8977, 2497, 48859, 288, 5819, 8977, 6839, 5935, 5935, 15060, 3113, 10474, 13265, 495, 13165, 5584, 22878, 16441, 1931, 6005, 14239, 1777, 368, 2093, 4336, 277, 14272, 316, 9814, 13990, 2393, 41134, 8106, 5916, 12478, 15299, 7644, 3708, 4314, 2323, 10601, 15061, 19828, 25501, 2366, 21189, 15563, 25772, 30500, 31757, 5252, 28214, 983, 10444, 15413, 9874, 8977, 8800, 17644, 308, 11715, 8946, 18266, 14885, 2736, 7733, 17301, 25072, 5405, 15232, 467, 16444, 17979, 27519, 23568, 31172, 29144, 22749, 43608, 13810, 415, 2485, 13126, 3430, 308, 454, 67, 13020, 30777, 30777, 34711, 8701, 1036, 729, 29901, 1036, 5540, 915, 4170, 10047, 4190, 15554, 6428, 1616, 1021, 7660, 18057, 15683, 5412, 289, 2564, 6877, 27678, 27678, 25558, 1182, 22537, 1027, 4862, 36769, 39844, 14335, 41968, 7604, 8223, 31489, 2156, 4771, 16882, 6953, 14509, 10303, 15224, 13209, 45808, 43497, 479, 47132, 40231, 1994, 10586, 9845, 285, 4891, 660, 6167, 7621, 18002, 12835, 2666, 40529, 1232, 10329, 19341, 18873, 17124, 19789, 1451, 3002, 1657, 28287, 38371, 20450, 14871, 28738, 5793, 33211, 415, 35537, 19972, 16558, 49364, 48577, 288, 2150, 9335, 2603, 14477, 2872, 13915, 6174, 12023, 8891, 9007, 1085, 7771, 36396, 27000, 7545, 10162, 15936, 15936, 263, 35370, 1637, 5003, 10752, 285, 404, 18757, 5584, 32256, 10211, 5422, 285, 789, 21133, 76, 789, 1963, 16912, 28520, 17864, 25245, 25422, 5116, 1021, 6122, 17351, 1113, 1155, 660, 10712, 19916, 38987, 17598, 8011, 2010, 46031, 6701, 3056, 3735, 12876, 430, 21670, 14361, 39517, 7521, 24471, 7521, 32680, 27043, 3425, 32959, 6839, 10746, 6839, 22154, 539, 6103, 12581, 474, 11025, 15857, 1790, 4057, 2655, 20461, 11729, 3348, 8262, 5977, 7533, 3465, 3348, 3323, 11968, 14507, 26296, 25099, 293, 48241, 17008, 41738, 613, 64, 26636, 25286, 26667, 31738, 31738, 263, 41350, 3112, 18364, 21613, 13385, 20236, 11022, 39901, 3072, 26346, 11745, 4590, 19132, 2298, 293, 4286, 18560, 2508, 28774, 8022, 12644, 6757, 12656, 14256, 1410, 263, 6614, 4618, 3600, 1216, 623, 302, 276, 9403, 1359, 10157, 549, 10717, 17793, 20349, 7480, 9433, 458, 1436, 473, 48915, 2712, 4116, 458, 959, 6107, 16825, 38914, 1787, 1410, 353, 21219, 8901, 30089, 27517, 15027, 393, 3704, 19780, 2401, 2879, 474, 1516, 64, 474, 45636, 29649, 19127, 5243, 6787, 47590, 47885, 26811, 11865, 6569, 1630, 11464, 5858, 19550, 13915, 18619, 10708, 6808, 17182, 20264, 4097, 22740, 3896, 6450, 264, 4066, 6450, 20189, 20433, 10746, 31889, 2497, 14659, 707, 30445, 707, 36953, 427, 707, 75, 41786, 23529, 629, 78, 3575, 19320, 525, 19320, 2848, 9580, 9580, 26230, 26924, 46794, 8268, 427, 3110, 25721, 7543, 9403, 900, 6616, 35356, 7786, 877, 673, 945, 9629, 18316, 7582, 10147, 2657, 5516, 35685, 39387, 49756, 1353, 17292, 6297, 6450, 282, 1017, 14710, 33677, 289, 2577, 599, 671, 14643, 6639, 293, 264, 12311, 965, 10613, 14595, 34164, 23967, 38677, 3013, 273, 7750, 19533, 32263, 17802, 34902, 9260, 13647, 17492, 42809, 17141, 599, 11736, 15246, 4712, 10834, 599, 12114, 39870, 5185, 15635, 39129, 4437, 1241, 40206, 27268, 527, 24556, 24556, 913, 11662, 11662, 263, 6076, 13170, 9107, 16046, 18761, 27656, 17977, 336, 64, 20053, 2876, 2382, 19702, 7825, 4859, 665, 328, 27735, 4283, 7815, 3881, 38753, 27635, 46027, 3623, 23016, 14787, 4731, 29202, 8800, 29654, 35938, 29092, 599, 970, 37923, 4704, 665, 500, 25749, 21181, 336, 10646, 5078, 36842, 827, 38229, 3084, 1302, 14147, 47884, 9154, 2685, 313, 1758, 3677, 313, 1758, 3953, 15558, 8887, 573, 499, 313, 5581, 31557, 11105, 1332, 12403, 9839, 17763, 19781, 284, 1603, 16146, 24240, 10479, 82, 2891, 3524, 16162, 32680, 16162, 27729, 28034, 28034, 2971, 24808, 13373, 3654, 38278, 13913, 16468, 25359, 7030, 26473, 49246, 5509, 491, 10957, 778, 38886, 256, 808, 417, 7779, 665, 1453, 9107, 25510, 739, 4563, 434, 38660, 8290, 17076, 21723, 22580, 410, 589, 2008, 38283, 3355, 13008, 39328, 20518, 2342, 1660, 1660, 45690, 21990, 5046, 47973, 17135, 49235, 48216, 7825, 5657, 808, 21060, 4324, 38866, 266, 9346, 6503, 21302, 7862, 31894, 21716, 15050, 13608, 2046, 3822, 4314, 3526, 2604, 34840, 39599, 35960, 3822, 30605, 4898, 3323, 4898, 1818, 23849, 29908, 9505, 2646, 13810, 14441, 27074, 34561, 11506, 1008, 331, 321, 20146, 27406, 456, 3325, 48992, 19974, 1976, 1229, 45045]
commaperiod = [11, 13]
# see vis-chatgpt.ipynb
toremove = [751, 510, 5894, 287, 11240, 4417, 866, 220, 13701, 329, 503, 9653, 28450, 4894, 5485, 1309, 1622, 16759, 4043, 8931, 42145, 20667, 1497, 3608, 2832, 14528, 4255, 13015, 12116, 6330, 6992, 9391, 286, 2651, 656, 1364, 2650, 5852, 10012, 662, 36717, 14782, 32857, 422, 1278, 736, 1720, 21099, 27172, 8251, 25432, 36167, 8122, 1401, 24359, 290, 5207, 28902, 3830, 2119, 23126, 27805, 13222, 9799, 12187, 826, 19474, 8420, 8242, 15867, 26320, 8234, 757, 2883, 2134, 6482, 5713, 3275, 4391, 2354, 27537, 3440, 19078, 13516, 8769, 5461, 832, 3053, 26633, 10649, 598, 3188, 3650, 10283, 6565, 4129, 670, 6940, 2245, 2378, 5739, 23361, 22636, 7354, 25411, 24667, 9583, 34722, 5253, 1218, 787, 379, 47539, 1486, 19396, 3349, 1057, 9941, 4074, 20698, 1319, 869, 2641, 7577, 11904, 2922, 13833, 18746, 1598, 1334, 22353, 3024, 2431, 5201, 23972, 28713, 10421, 3758, 10154, 1627, 3280, 23746, 2099, 649, 31103, 3328, 13197, 13092, 5101, 22007, 9585, 4776, 13737, 2721, 6203, 35971, 10171, 3354, 11376, 18821, 20932, 2420, 2292, 1271, 11705, 1176, 1051, 19096, 3151, 30407, 6460, 1088, 6431, 3307, 1633, 13091, 7679, 36755, 37113, 10965, 1296, 46376, 1986, 11626, 16481, 1167, 14022, 8335, 4439, 3359, 6004, 1730, 3124, 3817, 2824, 3613, 28602, 19908, 6737, 23319, 374, 11743, 16867, 6001, 25724, 30054, 1989, 39406, 34397, 17920, 300, 13544, 15787, 1064, 33270, 262, 517, 16869, 25629, 14000, 4710, 5743, 27318, 32595, 2222, 8237, 2793, 27952, 3850, 9168, 595, 3195, 13819, 14559, 14746, 24885, 12734, 279, 9009, 7500, 2457, 390, 1458, 5951, 2740, 5203, 886, 10862, 9563, 25394, 20726, 7586, 10971, 3350, 3835, 9622, 36708, 23959, 1978, 2209, 2615, 15155, 5112, 9592, 18051, 1735, 3272, 7263, 39990, 6994, 19001, 9848, 1128, 1667, 781, 11135, 2882, 21682, 3709, 3335, 8966, 6115, 838, 37282, 3606, 5236, 339, 10559, 6979, 6074, 25661, 37594, 43140, 32051, 7238, 8960, 12763, 21226, 466, 9416]

class RestrictiveTokensLogitsProcessor(LogitsProcessor):
    """ Restrictive decoding is done by adding logits_bias to the relevant tokens. Based on:
    https://help.openai.com/en/articles/5247780-using-logit-bias-to-define-token-probability
    """

    def __init__(self,
                 restrictive_token_ids: npt.NDArray[int],
                 logits_bias: int = 100):
        self.restrictive_token_ids = restrictive_token_ids
        self.logits_bias = logits_bias

    def __call__(self, input_ids: torch.LongTensor, scores: torch.FloatTensor) -> torch.FloatTensor:
        scores[:, self.restrictive_token_ids] += self.logits_bias
        return scores

logit_processor = RestrictiveTokensLogitsProcessor(np.array(
    vtokens + ntokens + commaperiod,
))